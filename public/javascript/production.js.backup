/* ============================================================
   GOODIES PRODUCTION JAVASCRIPT v2.0
   Complete, production-ready shared functionality
   ============================================================ */

(function() {
  'use strict';

  /* =========================
     UTILITY FUNCTIONS
     ========================= */
  
  // Safe localStorage access with fallback
  const storage = {
    get: function(key) {
      try {
        return localStorage.getItem(key);
      } catch (e) {
        console.warn('localStorage not available:', e);
        return null;
      }
    },
    set: function(key, value) {
      try {
        localStorage.setItem(key, value);
        return true;
      } catch (e) {
        console.warn('localStorage not available:', e);
        return false;
      }
    },
    remove: function(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        console.warn('localStorage not available:', e);
        return false;
      }
    }
  };

  // Debounce function for performance
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Throttle function for scroll events
  function throttle(func, limit) {
    let inThrottle;
    return function(...args) {
      if (!inThrottle) {
        func.apply(this, args);
        inThrottle = true;
        setTimeout(() => inThrottle = false, limit);
      }
    };
  }

  // Format currency
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }

  // Format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }).format(date);
  }

  // Calculate days remaining
  function daysRemaining(endDate) {
    const now = new Date();
    const end = new Date(endDate);
    const diff = end - now;
    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    return days;
  }

  /* =========================
     API HELPER
     ========================= */
  
  const API = {
    baseURL: '/api',
    
    async request(endpoint, options = {}) {
      const token = storage.get('goodies_token');
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (token && !options.skipAuth) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      try {
        const response = await fetch(`${this.baseURL}${endpoint}`, {
          ...options,
          headers
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || 'Request failed');
        }
        
        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    },
    
    get(endpoint, options = {}) {
      return this.request(endpoint, { ...options, method: 'GET' });
    },
    
    post(endpoint, body, options = {}) {
      return this.request(endpoint, {
        ...options,
        method: 'POST',
        body: JSON.stringify(body)
      });
    },
    
    put(endpoint, body, options = {}) {
      return this.request(endpoint, {
        ...options,
        method: 'PUT',
        body: JSON.stringify(body)
      });
    },
    
    delete(endpoint, options = {}) {
      return this.request(endpoint, { ...options, method: 'DELETE' });
    }
  };

  /* =========================
     TOAST NOTIFICATIONS
     ========================= */
  
  const Toast = {
    container: null,
    
    init() {
      if (!this.container) {
        this.container = document.createElement('div');
        this.container.className = 'toast-container';
        document.body.appendChild(this.container);
      }
    },
    
    show(message, type = 'info', duration = 4000) {
      this.init();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'polite');
      
      this.container.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove
      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
          toast.remove();
        });
      }, duration);
    },
    
    success(message) {
      this.show(message, 'success');
    },
    
    error(message) {
      this.show(message, 'error');
    },
    
    warning(message) {
      this.show(message, 'warning');
    },
    
    info(message) {
      this.show(message, 'info');
    }
  };

  // Expose Toast globally
  window.showToast = Toast.show.bind(Toast);

  /* =========================
     HEADER & NAVIGATION
     ========================= */
  
  function initHeader() {
    const hamburger = document.getElementById('hamburger');
    const nav = document.getElementById('mainNav');
    
    if (hamburger && nav) {
      hamburger.addEventListener('click', () => {
        const isOpen = hamburger.classList.toggle('open');
        nav.classList.toggle('active', isOpen);
        hamburger.setAttribute('aria-expanded', String(isOpen));
        
        // Lock body scroll when mobile menu is open
        document.body.style.overflow = isOpen ? 'hidden' : '';
      });
      
      // Close menu on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && nav.classList.contains('active')) {
          hamburger.classList.remove('open');
          nav.classList.remove('active');
          hamburger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
    }
    
    // Highlight current page
    highlightCurrentPage();
    
    // Search toggle
    initSearchToggle();
    
    // Dropdown menus
    initDropdowns();
    
    // Sticky header on scroll
    initStickyHeader();
  }

  function highlightCurrentPage() {
    const links = document.querySelectorAll('.site-header a.nav-link');
    const currentPath = window.location.pathname;
    
    links.forEach(link => {
      const linkPath = new URL(link.href).pathname;
      
      if (linkPath === currentPath || 
          (currentPath === '/' && linkPath === '/index.html') ||
          (currentPath === '/index.html' && linkPath === '/')) {
        link.setAttribute('aria-current', 'page');
        link.classList.add('active');
      }
    });
  }

  function initSearchToggle() {
    const searchWrap = document.querySelector('.header-search');
    const searchBtns = document.querySelectorAll('[data-toggle-search]');
    
    searchBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        if (searchWrap) {
          const isOpen = searchWrap.classList.toggle('open');
          if (isOpen) {
            const input = searchWrap.querySelector('input[type="search"]');
            if (input) setTimeout(() => input.focus(), 100);
          }
        }
      });
    });
    
    // Close search on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && searchWrap && searchWrap.classList.contains('open')) {
        searchWrap.classList.remove('open');
      }
    });
  }

  function initDropdowns() {
    const dropdowns = document.querySelectorAll('.nav-item.dropdown');
    
    dropdowns.forEach(dropdown => {
      const toggle = dropdown.querySelector('.dropdown-toggle');
      if (!toggle) return;
      
      // Desktop hover
      dropdown.addEventListener('mouseenter', () => {
        if (window.innerWidth > 768) {
          dropdown.classList.add('open');
          toggle.setAttribute('aria-expanded', 'true');
        }
      });
      
      dropdown.addEventListener('mouseleave', () => {
        if (window.innerWidth > 768) {
          dropdown.classList.remove('open');
          toggle.setAttribute('aria-expanded', 'false');
        }
      });
      
      // Mobile/tablet click
      toggle.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          const isOpen = dropdown.classList.toggle('open');
          toggle.setAttribute('aria-expanded', String(isOpen));
        }
      });
    });
    
    // Close dropdowns on window resize
    window.addEventListener('resize', debounce(() => {
      if (window.innerWidth > 768) {
        dropdowns.forEach(d => {
          d.classList.remove('open');
          const toggle = d.querySelector('.dropdown-toggle');
          if (toggle) toggle.setAttribute('aria-expanded', 'false');
        });
      }
    }, 250));
  }

  function initStickyHeader() {
    const header = document.querySelector('.site-header');
    if (!header) return;
    
    const handleScroll = throttle(() => {
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    }, 100);
    
    window.addEventListener('scroll', handleScroll, { passive: true });
  }

  /* =========================
     SOCIAL SHARING
     ========================= */
  
  function initSocialSharing() {
    const shareButtons = document.querySelectorAll('[data-share]');
    
    shareButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const network = button.dataset.share;
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        
        const shareURLs = {
          twitter: `https://twitter.com/intent/tweet?url=${url}&text=${title}`,
          facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
          linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}`
        };
        
        if (shareURLs[network]) {
          window.open(
            shareURLs[network],
            '_blank',
            'width=600,height=500,resizable=yes,scrollbars=yes'
          );
        }
      });
    });
  }

  /* =========================
     SCROLL ANIMATIONS
     ========================= */
  
  function initScrollAnimations() {
    const elements = document.querySelectorAll('.reveal');
    
    if (!elements.length || !('IntersectionObserver' in window)) {
      // Fallback for browsers without IntersectionObserver
      elements.forEach(el => el.classList.add('is-visible'));
      return;
    }
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });
    
    elements.forEach(el => observer.observe(el));
  }

  /* =========================
     FORM VALIDATION
     ========================= */
  
  const FormValidator = {
    rules: {
      required: (value) => value.trim() !== '',
      email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
      min: (value, min) => value.length >= min,
      max: (value, max) => value.length <= max,
      number: (value) => !isNaN(value) && value !== '',
      minValue: (value, min) => parseFloat(value) >= min,
      maxValue: (value, max) => parseFloat(value) <= max
    },
    
    messages: {
      required: 'This field is required',
      email: 'Please enter a valid email address',
      min: 'Minimum length is {min} characters',
      max: 'Maximum length is {max} characters',
      number: 'Please enter a valid number',
      minValue: 'Value must be at least {min}',
      maxValue: 'Value must not exceed {max}'
    },
    
    validateField(input) {
      const errors = [];
      const value = input.value;
      
      // Required validation
      if (input.hasAttribute('required') && !this.rules.required(value)) {
        errors.push(this.messages.required);
      }
      
      // Email validation
      if (input.type === 'email' && value && !this.rules.email(value)) {
        errors.push(this.messages.email);
      }
      
      // Min length
      const minLength = input.getAttribute('minlength');
      if (minLength && !this.rules.min(value, parseInt(minLength))) {
        errors.push(this.messages.min.replace('{min}', minLength));
      }
      
      // Max length
      const maxLength = input.getAttribute('maxlength');
      if (maxLength && !this.rules.max(value, parseInt(maxLength))) {
        errors.push(this.messages.max.replace('{max}', maxLength));
      }
      
      // Number validation
      if (input.type === 'number' && value) {
        if (!this.rules.number(value)) {
          errors.push(this.messages.number);
        } else {
          const min = input.getAttribute('min');
          const max = input.getAttribute('max');
          
          if (min && !this.rules.minValue(value, parseFloat(min))) {
            errors.push(this.messages.minValue.replace('{min}', min));
          }
          
          if (max && !this.rules.maxValue(value, parseFloat(max))) {
            errors.push(this.messages.maxValue.replace('{max}', max));
          }
        }
      }
      
      return errors;
    },
    
    showError(input, message) {
      const errorId = input.getAttribute('aria-describedby');
      const errorElement = errorId ? document.getElementById(errorId.split(' ').find(id => id.includes('error'))) : null;
      
      input.classList.add('error');
      input.setAttribute('aria-invalid', 'true');
      
      if (errorElement) {
        errorElement.textContent = message;
      }
    },
    
    clearError(input) {
      const errorId = input.getAttribute('aria-describedby');
      const errorElement = errorId ? document.getElementById(errorId.split(' ').find(id => id.includes('error'))) : null;
      
      input.classList.remove('error');
      input.removeAttribute('aria-invalid');
      
      if (errorElement) {
        errorElement.textContent = '';
      }
    },
    
    initForm(form) {
      const inputs = form.querySelectorAll('input, textarea, select');
      
      inputs.forEach(input => {
        // Validate on blur
        input.addEventListener('blur', () => {
          const errors = this.validateField(input);
          if (errors.length > 0) {
            this.showError(input, errors[0]);
          } else {
            this.clearError(input);
          }
        });
        
        // Clear error on input
        input.addEventListener('input', () => {
          if (input.classList.contains('error')) {
            this.clearError(input);
          }
        });
      });
      
      // Validate on submit
      form.addEventListener('submit', (e) => {
        let hasErrors = false;
        
        inputs.forEach(input => {
          const errors = this.validateField(input);
          if (errors.length > 0) {
            this.showError(input, errors[0]);
            hasErrors = true;
            
            // Focus first error
            if (!hasErrors) {
              input.focus();
            }
          }
        });
        
        if (hasErrors) {
          e.preventDefault();
          Toast.error('Please fix the errors in the form');
        }
      });
    }
  };

  /* =========================
     CHARACTER COUNTER
     ========================= */
  
  function initCharacterCounters() {
    const textareas = document.querySelectorAll('textarea[maxlength]');
    
    textareas.forEach(textarea => {
      const maxLength = textarea.getAttribute('maxlength');
      const counterId = textarea.id + 'CharCount';
      const counter = document.getElementById(counterId) || document.getElementById('charCount');
      
      if (counter) {
        const updateCount = () => {
          counter.textContent = textarea.value.length;
        };
        
        textarea.addEventListener('input', updateCount);
        updateCount();
      }
    });
  }

  /* =========================
     LOADING BUTTON STATE
     ========================= */
  
  function setButtonLoading(button, loading = true) {
    const textSpan = button.querySelector('.btn-text');
    const loaderSpan = button.querySelector('.btn-loader');
    
    if (loading) {
      button.disabled = true;
      if (textSpan) textSpan.style.opacity = '0';
      if (loaderSpan) loaderSpan.classList.remove('hidden');
    } else {
      button.disabled = false;
      if (textSpan) textSpan.style.opacity = '1';
      if (loaderSpan) loaderSpan.classList.add('hidden');
    }
  }

  /* =========================
     IMAGE PREVIEW
     ========================= */
  
  function initImageUpload() {
    const uploadZone = document.getElementById('uploadZone');
    const imageInput = document.getElementById('imageUploadInput');
    const previewContainer = document.getElementById('imagePreview');
    
    if (!uploadZone || !imageInput) return;
    
    // Click to upload
    uploadZone.addEventListener('click', () => imageInput.click());
    
    // Keyboard access
    uploadZone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        imageInput.click();
      }
    });
    
    // File selection
    imageInput.addEventListener('change', handleImageSelect);
    
    // Drag and drop
    ['dragenter', 'dragover'].forEach(event => {
      uploadZone.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.style.borderColor = 'var(--lux-gold)';
        uploadZone.style.background = 'rgba(212,175,55,0.05)';
      });
    });
    
    ['dragleave', 'drop'].forEach(event => {
      uploadZone.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadZone.style.borderColor = '';
        uploadZone.style.background = '';
      });
    });
    
    uploadZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        imageInput.files = files;
        handleImageSelect();
      }
    });
    
    function handleImageSelect() {
      const file = imageInput.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.match('image.*')) {
        Toast.error('Please select an image file');
        return;
      }
      
      // Validate file size (5MB)
      if (file.size > 5 * 1024 * 1024) {
        Toast.error('Image must be less than 5MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        if (previewContainer) {
          previewContainer.innerHTML = `
            <img src="${e.target.result}" alt="Campaign preview">
            <button type="button" class="remove-image" aria-label="Remove image">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          `;
          previewContainer.classList.remove('hidden');
          
          // Remove button functionality
          const removeBtn = previewContainer.querySelector('.remove-image');
          removeBtn.addEventListener('click', () => {
            imageInput.value = '';
            previewContainer.innerHTML = '';
            previewContainer.classList.add('hidden');
          });
        }
      };
      reader.readAsDataURL(file);
    }
  }

  /* =========================
     INITIALIZATION
     ========================= */
  
  function init() {
    // Initialize all modules
    initHeader();
    initSocialSharing();
    initScrollAnimations();
    initCharacterCounters();
    initImageUpload();
    
    // Initialize form validation on all forms
    document.querySelectorAll('form[novalidate]').forEach(form => {
      FormValidator.initForm(form);
    });
    
    // Log initialization
    console.log('âœ… Goodies Production JS initialized');
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Expose utilities globally
  window.Goodies = {
    API,
    Toast,
    FormValidator,
    storage,
    debounce,
    throttle,
    formatCurrency,
    formatDate,
    daysRemaining,
    setButtonLoading
  };

})();