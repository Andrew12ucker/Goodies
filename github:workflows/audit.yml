name: Repo Audit
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version-file: '.nvmrc', cache: 'npm' }
      - run: npm ci --workspaces --if-present
      - run: npm run lint --workspaces --if-present
      - run: npm run typecheck --workspaces --if-present
      - run: npm test --workspaces --if-present
      - name: npm audit
        run: npm audit --audit-level=high || true
      - name: CodeQL
        uses: github/codeql-action/init@v3
        with: { languages: javascript }
      - uses: github/codeql-action/analyze@v3
      - name: TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with: { path: . }
